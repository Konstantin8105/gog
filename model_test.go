package gog

import (
	"fmt"
	"io/ioutil"
	"os"
	"testing"
)

func TestCopy(t *testing.T) {
	m := Model{
		Points:    []Point{{1, 2}},
		Lines:     [][3]int{{3, 4, 5}, {6, 7, 8}},
		Arcs:      [][4]int{{11, 12, 13, 14}, {15, 16, 17, 18}},
		Triangles: [][4]int{{21, 22, 23, 34}},
	}
	equal := func(m0, m1 *Model) bool {
		return m0.String() == m1.String()
	}
	var c Model
	if equal(&m, &c) {
		t.Fatalf("strange 1")
	}
	c = m.Copy()
	if !equal(&m, &c) {
		t.Fatalf("not full copy\n%s\n%s", m.String(), c.String())
	}
	c.Lines[1][1] = -4
	if equal(&m, &c) {
		t.Fatalf("strange 2")
	}
}

func ExampleModel() {
	var m Model
	var state int
	// view result in dxf format
	view := func() {
		if err := ioutil.WriteFile(
			fmt.Sprintf("ExampleModelOnState%02d.dxf", state),
			[]byte(m.Dxf()),
			0644,
		); err != nil {
			panic(err)
		}
		state++
	}
	// create model
	m.AddCircle(0, 0, 1, 1)
	m.AddLine(Point{-1, 0}, Point{1, 0}, 2)
	m.AddLine(Point{0, -1}, Point{0, 1}, 3)
	fmt.Fprintf(os.Stdout, "Only structural lines:\n%s", m)
	view() // 0
	m.Intersection()
	view() // 1
	m.Split(0.2)
	view() // 2
	m.ArcsToLines()
	view() // 3
	m.RemoveEmptyPoints()
	view() // 4
	m.ConvexHullTriangles()
	view() // 5
	m.Intersection()
	view() // 6
	m.RemoveEmptyPoints()
	view() // 7
	m.Triangles = nil
	mesh, err := New(m)
	if err != nil {
		fmt.Fprintf(os.Stdout, "Error: %v\n", err)
		return
	}
	err = mesh.Materials()
	if err != nil {
		fmt.Fprintf(os.Stdout, "Error: %v\n", err)
		return
	}
	//
	for _, p := range []Point{
		Point{+0.5, +0.5},
		Point{+0.5, -0.5},
		Point{-0.5, -0.5},
		Point{-0.5, +0.5},
	} {
		mat, err := mesh.GetMaterials(p)
		if err != nil {
			fmt.Fprintf(os.Stdout, "Error: %v\n", err)
			return
		}
		fmt.Fprintf(os.Stdout, "%v %v\n", p, mat)
	}
	m.Get(mesh)
	view() // 8
	fmt.Fprintf(os.Stdout, "After intersection:\n%s", m)
	fmt.Fprintf(os.Stdout, "Minimal distance between points:\n%.4f\n", m.MinPointDistance())
	if err := m.Combine(10, 1.1); err != nil {
		panic(err)
	}
	view() // 9
	fmt.Fprintf(os.Stdout, "After combine:\n%s", m)

	// Output:
	// Only structural lines:
	// Points:
	// 000	{+0.0000 -1.0000}
	// 001	{+1.0000 +0.0000}
	// 002	{+0.0000 +1.0000}
	// 003	{-1.0000 +0.0000}
	// Lines:
	// 000	[  3   1   2]
	// 001	[  0   2   3]
	// Arcs:
	// 000	[  0   1   2   1]
	// 001	[  2   3   0   1]
	// [5.00000e-01,5.00000e-01] [51]
	// [5.00000e-01,-5.00000e-01] [50]
	// [-5.00000e-01,-5.00000e-01] [53]
	// [-5.00000e-01,5.00000e-01] [52]
	// After intersection:
	// Points:
	// 000	{+0.0000 -1.0000}
	// 001	{+1.0000 +0.0000}
	// 002	{+0.0000 +1.0000}
	// 003	{-1.0000 +0.0000}
	// 004	{+0.0000 +0.0000}
	// 005	{-0.7071 +0.7071}
	// 006	{-0.7071 -0.7071}
	// 007	{+0.7071 -0.7071}
	// 008	{+0.7071 +0.7071}
	// 009	{+0.0000 -0.8333}
	// 010	{+0.0000 -0.6667}
	// 011	{+0.0000 -0.5000}
	// 012	{+0.0000 -0.3333}
	// 013	{+0.0000 -0.1667}
	// 014	{+0.0000 +0.1667}
	// 015	{+0.0000 +0.3333}
	// 016	{+0.0000 +0.5000}
	// 017	{+0.0000 +0.6667}
	// 018	{+0.0000 +0.8333}
	// 019	{-0.8333 +0.0000}
	// 020	{-0.6667 +0.0000}
	// 021	{-0.5000 +0.0000}
	// 022	{-0.3333 +0.0000}
	// 023	{-0.1667 +0.0000}
	// 024	{+0.1667 +0.0000}
	// 025	{+0.3333 +0.0000}
	// 026	{+0.5000 +0.0000}
	// 027	{+0.6667 +0.0000}
	// 028	{+0.8333 +0.0000}
	// 029	{-0.1951 +0.9808}
	// 030	{-0.3827 +0.9239}
	// 031	{-0.5556 +0.8315}
	// 032	{-0.8315 +0.5556}
	// 033	{-0.9239 +0.3827}
	// 034	{-0.9808 +0.1951}
	// 035	{-0.9808 -0.1951}
	// 036	{-0.9239 -0.3827}
	// 037	{-0.8315 -0.5556}
	// 038	{-0.5556 -0.8315}
	// 039	{-0.3827 -0.9239}
	// 040	{-0.1951 -0.9808}
	// 041	{+0.1951 -0.9808}
	// 042	{+0.3827 -0.9239}
	// 043	{+0.5556 -0.8315}
	// 044	{+0.8315 -0.5556}
	// 045	{+0.9239 -0.3827}
	// 046	{+0.9808 -0.1951}
	// 047	{+0.9808 +0.1951}
	// 048	{+0.9239 +0.3827}
	// 049	{+0.8315 +0.5556}
	// 050	{+0.5556 +0.8315}
	// 051	{+0.3827 +0.9239}
	// 052	{+0.1951 +0.9808}
	// Lines:
	// 000	[  0   9   3]
	// 001	[  9  10   3]
	// 002	[ 10  11   3]
	// 003	[ 11  12   3]
	// 004	[ 12  13   3]
	// 005	[ 13   4   3]
	// 006	[  4  14   3]
	// 007	[ 14  15   3]
	// 008	[ 15  16   3]
	// 009	[ 16  17   3]
	// 010	[ 17  18   3]
	// 011	[ 18   2   3]
	// 012	[  3  19   2]
	// 013	[ 19  20   2]
	// 014	[ 20  21   2]
	// 015	[ 21  22   2]
	// 016	[ 22  23   2]
	// 017	[ 23   4   2]
	// 018	[  4  24   2]
	// 019	[ 24  25   2]
	// 020	[ 25  26   2]
	// 021	[ 26  27   2]
	// 022	[ 27  28   2]
	// 023	[ 28   1   2]
	// 024	[  2  29   1]
	// 025	[ 29  30   1]
	// 026	[ 30  31   1]
	// 027	[ 31   5   1]
	// 028	[  5  32   1]
	// 029	[ 32  33   1]
	// 030	[ 33  34   1]
	// 031	[ 34   3   1]
	// 032	[  3  35   1]
	// 033	[ 35  36   1]
	// 034	[ 36  37   1]
	// 035	[ 37   6   1]
	// 036	[  6  38   1]
	// 037	[ 38  39   1]
	// 038	[ 39  40   1]
	// 039	[ 40   0   1]
	// 040	[  0  41   1]
	// 041	[ 41  42   1]
	// 042	[ 42  43   1]
	// 043	[ 43   7   1]
	// 044	[  7  44   1]
	// 045	[ 44  45   1]
	// 046	[ 45  46   1]
	// 047	[ 46   1   1]
	// 048	[  1  47   1]
	// 049	[ 47  48   1]
	// 050	[ 48  49   1]
	// 051	[ 49   8   1]
	// 052	[  8  50   1]
	// 053	[ 50  51   1]
	// 054	[ 51  52   1]
	// 055	[ 52   2   1]
	// Triangles:
	// 000	[  0   9  41  50]
	// 001	[  9  10  41  50]
	// 002	[ 10  42  41  50]
	// 003	[ 10  43  42  50]
	// 004	[ 10  11  43  50]
	// 005	[ 11   7  43  50]
	// 006	[ 12   7  11  50]
	// 007	[  7  26  44  50]
	// 008	[ 26  27  44  50]
	// 009	[ 27  45  44  50]
	// 010	[ 49  26   8  51]
	// 011	[ 29  17  30  52]
	// 012	[ 17  31  30  52]
	// 013	[ 31  16   5  52]
	// 014	[ 22   5  15  52]
	// 015	[  5  21  32  52]
	// 016	[ 32  20  33  52]
	// 017	[ 21   6  37  53]
	// 018	[ 38  10  39  53]
	// 019	[  8  15  16  51]
	// 020	[ 25   8  26  51]
	// 021	[ 27  49  48  51]
	// 022	[ 40   9   0  53]
	// 023	[ 10  40  39  53]
	// 024	[ 15  24  14  51]
	// 025	[ 40  10   9  53]
	// 026	[  6  11  38  53]
	// 027	[ 38  11  10  53]
	// 028	[ 20  21  37  53]
	// 029	[  7  25  26  50]
	// 030	[  6  12  11  53]
	// 031	[ 35  20  36  53]
	// 032	[ 24  25  12  50]
	// 033	[ 36  20  37  53]
	// 034	[ 19  20  35  53]
	// 035	[ 13  24  12  50]
	// 036	[ 16  50   8  51]
	// 037	[ 16  17  50  51]
	// 038	[ 14  22  15  52]
	// 039	[ 17  51  50  51]
	// 040	[ 16  15   5  52]
	// 041	[ 17  52  51  51]
	// 042	[ 17  16  31  52]
	// 043	[ 18   2  52  51]
	// 044	[ 17  18  52  51]
	// 045	[ 29  18  17  52]
	// 046	[ 18  29   2  52]
	// 047	[ 34  19   3  52]
	// 048	[ 20  34  33  52]
	// 049	[  3  19  35  53]
	// 050	[ 34  20  19  52]
	// 051	[ 21  22   6  53]
	// 052	[ 21  20  32  52]
	// 053	[ 22  12   6  53]
	// 054	[ 22  21   5  52]
	// 055	[ 22  13  12  53]
	// 056	[ 23  22  14  52]
	// 057	[ 14   4  23  52]
	// 058	[  4  13  23  53]
	// 059	[ 23  13  22  53]
	// 060	[  4  24  13  50]
	// 061	[ 24   4  14  51]
	// 062	[ 12  25   7  50]
	// 063	[ 15  25  24  51]
	// 064	[ 25  15   8  51]
	// 065	[ 47  27  48  51]
	// 066	[ 27  46  45  50]
	// 067	[ 49  27  26  51]
	// 068	[ 28  27  47  51]
	// 069	[  1  28  47  51]
	// 070	[ 46  28   1  50]
	// 071	[ 28  46  27  50]
	// Minimal distance between points:
	// 0.1667
	// After combine:
	// Points:
	// 000	{+0.0000 -1.0000}
	// 001	{+1.0000 +0.0000}
	// 002	{+0.0000 +1.0000}
	// 003	{-1.0000 +0.0000}
	// 004	{+0.0000 +0.0000}
	// 005	{-0.7071 +0.7071}
	// 006	{-0.7071 -0.7071}
	// 007	{+0.7071 -0.7071}
	// 008	{+0.7071 +0.7071}
	// 009	{+0.0000 -0.8333}
	// 010	{+0.0000 -0.6667}
	// 011	{+0.0000 -0.5000}
	// 012	{+0.0000 -0.3333}
	// 013	{+0.0000 -0.1667}
	// 014	{+0.0000 +0.1667}
	// 015	{+0.0000 +0.3333}
	// 016	{+0.0000 +0.5000}
	// 017	{+0.0000 +0.6667}
	// 018	{+0.0000 +0.8333}
	// 019	{-0.8333 +0.0000}
	// 020	{-0.6667 +0.0000}
	// 021	{-0.5000 +0.0000}
	// 022	{-0.3333 +0.0000}
	// 023	{-0.1667 +0.0000}
	// 024	{+0.1667 +0.0000}
	// 025	{+0.3333 +0.0000}
	// 026	{+0.5000 +0.0000}
	// 027	{+0.6667 +0.0000}
	// 028	{+0.8333 +0.0000}
	// 029	{-0.1951 +0.9808}
	// 030	{-0.3827 +0.9239}
	// 031	{-0.5556 +0.8315}
	// 032	{-0.8315 +0.5556}
	// 033	{-0.9239 +0.3827}
	// 034	{-0.9808 +0.1951}
	// 035	{-0.9808 -0.1951}
	// 036	{-0.9239 -0.3827}
	// 037	{-0.8315 -0.5556}
	// 038	{-0.5556 -0.8315}
	// 039	{-0.3827 -0.9239}
	// 040	{-0.1951 -0.9808}
	// 041	{+0.1951 -0.9808}
	// 042	{+0.3827 -0.9239}
	// 043	{+0.5556 -0.8315}
	// 044	{+0.8315 -0.5556}
	// 045	{+0.9239 -0.3827}
	// 046	{+0.9808 -0.1951}
	// 047	{+0.9808 +0.1951}
	// 048	{+0.9239 +0.3827}
	// 049	{+0.8315 +0.5556}
	// 050	{+0.5556 +0.8315}
	// 051	{+0.3827 +0.9239}
	// 052	{+0.1951 +0.9808}
	// Lines:
	// 000	[  0   9   3]
	// 001	[  9  10   3]
	// 002	[ 10  11   3]
	// 003	[ 11  12   3]
	// 004	[ 12  13   3]
	// 005	[ 13   4   3]
	// 006	[  4  14   3]
	// 007	[ 14  15   3]
	// 008	[ 15  16   3]
	// 009	[ 16  17   3]
	// 010	[ 17  18   3]
	// 011	[ 18   2   3]
	// 012	[  3  19   2]
	// 013	[ 19  20   2]
	// 014	[ 20  21   2]
	// 015	[ 21  22   2]
	// 016	[ 22  23   2]
	// 017	[ 23   4   2]
	// 018	[  4  24   2]
	// 019	[ 24  25   2]
	// 020	[ 25  26   2]
	// 021	[ 26  27   2]
	// 022	[ 27  28   2]
	// 023	[ 28   1   2]
	// 024	[  2  29   1]
	// 025	[ 29  30   1]
	// 026	[ 30  31   1]
	// 027	[ 31   5   1]
	// 028	[  5  32   1]
	// 029	[ 32  33   1]
	// 030	[ 33  34   1]
	// 031	[ 34   3   1]
	// 032	[  3  35   1]
	// 033	[ 35  36   1]
	// 034	[ 36  37   1]
	// 035	[ 37   6   1]
	// 036	[  6  38   1]
	// 037	[ 38  39   1]
	// 038	[ 39  40   1]
	// 039	[ 40   0   1]
	// 040	[  0  41   1]
	// 041	[ 41  42   1]
	// 042	[ 42  43   1]
	// 043	[ 43   7   1]
	// 044	[  7  44   1]
	// 045	[ 44  45   1]
	// 046	[ 45  46   1]
	// 047	[ 46   1   1]
	// 048	[  1  47   1]
	// 049	[ 47  48   1]
	// 050	[ 48  49   1]
	// 051	[ 49   8   1]
	// 052	[  8  50   1]
	// 053	[ 50  51   1]
	// 054	[ 51  52   1]
	// 055	[ 52   2   1]
	// Triangles:
	// 000	[  0   9  41  50]
	// 001	[  9  10  41  50]
	// 002	[ 10  11  43  50]
	// 003	[ 27  45  44  50]
	// 004	[ 17  31  30  52]
	// 005	[ 32  20  33  52]
	// 006	[ 38  10  39  53]
	// 007	[  8  15  16  51]
	// 008	[ 25   8  26  51]
	// 009	[ 27  49  48  51]
	// 010	[ 40   9   0  53]
	// 011	[ 15  24  14  51]
	// 012	[  7  25  26  50]
	// 013	[  6  12  11  53]
	// 014	[ 36  20  37  53]
	// 015	[ 13  24  12  50]
	// 016	[ 17  51  50  51]
	// 017	[ 16  15   5  52]
	// 018	[ 18   2  52  51]
	// 019	[ 18  29   2  52]
	// 020	[ 34  19   3  52]
	// 021	[  3  19  35  53]
	// 022	[ 21  22   6  53]
	// 023	[ 22  21   5  52]
	// 024	[ 23  22  14  52]
	// 025	[ 14   4  23  52]
	// 026	[  4  13  23  53]
	// 027	[ 23  13  22  53]
	// 028	[  4  24  13  50]
	// 029	[ 24   4  14  51]
	// 030	[  1  28  47  51]
	// 031	[ 46  28   1  50]
	// Quadrs:
	// 000	[ 11  10  38   6  53]
	// 001	[ 16  17  50   8  51]
	// 002	[ 21  20  32   5  52]
	// 003	[ 37  20  21   6  53]
	// 004	[ 26  27  44   7  50]
	// 005	[ 49  27  26   8  51]
	// 006	[ 31  17  16   5  52]
	// 007	[ 22  13  12   6  53]
	// 008	[ 15  14  22   5  52]
	// 009	[ 15   8  25  24  51]
	// 010	[ 25   7  12  24  50]
	// 011	[ 11  12   7  43  50]
	// 012	[ 29  18  17  30  52]
	// 013	[ 35  19  20  36  53]
	// 014	[ 17  18  52  51  51]
	// 015	[ 20  19  34  33  52]
	// 016	[ 47  28  27  48  51]
	// 017	[ 10   9  40  39  53]
	// 018	[ 27  28  46  45  50]
	// 019	[ 10  43  42  41  50]
}
